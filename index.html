<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Report</title>

    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Styling -->
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        h1, h2 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #4CAF50; color: white; }
        canvas { max-width: 100%; }
        input, button { padding: 8px; margin: 5px; }
    </style>
</head>
<body>

    <h1>Registration Reports</h1>

    <!-- One-time entry for Names and Roles -->
    <h2>Enter Names & Roles (One-Time Setup)</h2>
    <form id="setupForm">
        <input type="text" id="nameInput" placeholder="Enter Name" required>
        <input type="text" id="roleInput" placeholder="Enter Role" required>
        <button type="submit">Add</button>
    </form>

    <h2>Daily Registrations (Supervisor Only)</h2>
    <form id="registrationForm">
        <input type="date" id="dateInput" required>
        <select id="personSelect"></select>
        <input type="number" id="countInput" placeholder="Registrations" required>
        <button type="submit">Submit</button>
    </form>

    <h2>Daily Report</h2>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Role</th>
                <th>Registrations</th>
            </tr>
        </thead>
        <tbody id="dailyReport"></tbody>
    </table>

    <h2>Weekly Registration Graph</h2>
    <canvas id="weeklyChart"></canvas>

    <h2>Monthly Registration Graph</h2>
    <canvas id="monthlyChart"></canvas>

    <script>
        // Load Names & Roles (One-Time Entry)
        function loadNames() {
            let storedNames = localStorage.getItem("namesData");
            return storedNames ? JSON.parse(storedNames) : [];
        }

        function saveNames(data) {
            localStorage.setItem("namesData", JSON.stringify(data));
        }

        // Load Registration Data
        function loadRegistrations() {
            let storedData = localStorage.getItem("registrationData");
            return storedData ? JSON.parse(storedData) : [];
        }

        function saveRegistrations(data) {
            localStorage.setItem("registrationData", JSON.stringify(data));
        }

        // Add Name & Role (One-Time)
        document.getElementById("setupForm").addEventListener("submit", function(event) {
            event.preventDefault();
            let name = document.getElementById("nameInput").value.trim();
            let role = document.getElementById("roleInput").value.trim();

            if (!name || !role) {
                alert("Please enter valid name and role!");
                return;
            }

            let namesList = loadNames();
            namesList.push({ name, role });
            saveNames(namesList);

            alert("Name & Role Added!");
            updateDropdown();
            document.getElementById("setupForm").reset();
        });

        // Update Dropdown for Registration Input
        function updateDropdown() {
            let select = document.getElementById("personSelect");
            select.innerHTML = "";
            let namesList = loadNames();

            namesList.forEach(person => {
                let option = document.createElement("option");
                option.value = person.name;
                option.textContent = `${person.name} (${person.role})`;
                select.appendChild(option);
            });
        }

        // Add Daily Registrations
        document.getElementById("registrationForm").addEventListener("submit", function(event) {
            event.preventDefault();
            let date = document.getElementById("dateInput").value;
            let name = document.getElementById("personSelect").value;
            let count = parseInt(document.getElementById("countInput").value);

            if (!date || !name || isNaN(count)) {
                alert("Please enter valid data!");
                return;
            }

            let data = loadRegistrations();
            data.push({ date, name, count });
            saveRegistrations(data);
            alert("Data saved!");
            location.reload();
        });

        // Generate Reports
        function generateReports() {
            let data = loadRegistrations();
            let dailyTable = document.getElementById("dailyReport");
            let today = new Date().toISOString().split("T")[0];

            let weeklyCounts = {}, monthlyCounts = {};
            let lastWeekDates = Array.from({ length: 7 }, (_, i) => {
                let d = new Date();
                d.setDate(d.getDate() - i);
                return d.toISOString().split("T")[0];
            });

            let lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);

            data.forEach(row => {
                let date = row.date;
                let name = row.name;
                let count = parseInt(row.count) || 0;
                let role = loadNames().find(p => p.name === name)?.role || "Unknown";

                // Daily Report
                if (date === today) {
                    let tr = document.createElement("tr");
                    tr.innerHTML = `<td>${date}</td><td>${name}</td><td>${role}</td><td>${count}</td>`;
                    dailyTable.appendChild(tr);
                }

                // Weekly Report
                if (lastWeekDates.includes(date)) {
                    if (!weeklyCounts[date]) weeklyCounts[date] = 0;
                    weeklyCounts[date] += count;
                }

                // Monthly Report
                if (new Date(date) >= lastMonth) {
                    let monthKey = date.slice(0, 7);
                    if (!monthlyCounts[monthKey]) monthlyCounts[monthKey] = 0;
                    monthlyCounts[monthKey] += count;
                }
            });

            drawGraph("weeklyChart", Object.keys(weeklyCounts).reverse(), Object.values(weeklyCounts).reverse(), "Registrations Per Day (Weekly)");
            drawGraph("monthlyChart", Object.keys(monthlyCounts), Object.values(monthlyCounts), "Registrations Per Month");
        }

        // Draw Graph
        function drawGraph(canvasId, labels, data, title) {
            new Chart(document.getElementById(canvasId), {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: data,
                        backgroundColor: ["#FF5733", "#33FF57", "#3357FF", "#FF33A8", "#FFAA33", "#33AAFF", "#AA33FF"],
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        updateDropdown();
        generateReports();
    </script>

</body>
</html>
